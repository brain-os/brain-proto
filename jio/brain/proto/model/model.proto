syntax = "proto3";

package jio.brain.proto.model;

import "jio/brain/proto/model/author.proto";
import "jio/brain/proto/model/model_enums.proto";
import "jio/brain/proto/model/api_definition.proto";
import "jio/brain/proto/stores/article_store.proto";
import "jio/brain/proto/model/common_messages.proto";
import "jio/brain/proto/model/model_input_transformations.proto";
import "jio/brain/proto/model/model_output_transformations.proto";
import "jio/brain/proto/model/model_preprocessor.proto";
import "google/protobuf/timestamp.proto";


option java_package = "com.jio.brain.proto.model";
option java_outer_classname = "ModelProto";
option java_multiple_files = true;

//
//
//       +-------------------------->   HttpVariant
//      /  (oneof)
//     |                                                     1:N
// ModelGroup ---------------------->   ModelVariant --------------------------> ModelVersion
//     |                                      |                                     |
//     +--  Contributed by a Model Author     |                                     +---- Change Note
//     |                                      +--- Input Transformation             |
//     +--  Implements a specific API         |                                     +---- Persistent File ID 
//                                            +--- Output Transformation 
//                                            |
//                                            +--- Model Information 
//                                            |
//                                            +--- PreProcessor
//                                            |
//                                            +--- Config Param Values
//                                            |
//                                            +--- Pricing


/**
 * A Model Group represents a Versioned Model which is provided by
 * a given Author and implements a common API. Each ModelGroup has
 * one ModelVariant which encapsulates all the information about
 * the model and its versions. 
 *
 */
message ModelGroup {
    uint32                              model_group_id          = 1;
    string                              model_group_id_ext      = 2;        // Example: /.../models/author-id-1/SentimentAnalysis/scikit/132
    ModelAuthorIdentity                 author_id               = 3;        // The Author of the Model
    ApiDefinitionIdentity               api_id                  = 4;        // The API of which this model is a solution of
    string                              mg_name                 = 5;        // Unique Name within an Author's Implementations of API
    string                              mg_description          = 6;        // A brief description (possibly containing approach followed)
    
    oneof  variant_is_oneof {
        ModelVariant                    model_variant           = 7;
        HttpVariant                     http_variant            = 8;
    }

    ModelGroupStatus                    mg_status               = 9;        // Draft | Published | Archived
    google.protobuf.Timestamp           created_at              = 10;
    google.protobuf.Timestamp           last_modified_at        = 11;

    enum ModelGroupStatus {
        DRAFT       = 0;
        PUBLISHED   = 1;
        ARCHIVED    = 2;
    }

}



            // ------------------------------------------------------------------ //
            //                 Model Variant Specific Messages
            // ------------------------------------------------------------------ //



/**
 * Information about a given Model. The information encapsulated by
 * this messages remains fixed for all versions of that model. 
 */
message ModelVariant {
                string                                          mv_name                         = 1;    
                StandardApiInputToModelInputTransformation      input_transformation            = 2;    
                ModelOutputToStandardApiOutputTransformation    output_transformation           = 3;
                ModelDependencies                               model_dependencies              = 4;    
    repeated    ModelVersion                                    model_versions                  = 5;
                ModelPreprocessor                               preprocessor                    = 6;
    repeated    ApiFieldNameAndValue                            configurational_parameters      = 7;    // Values of various Configuration Parameters associated with the API Definition
                PricingRange                                    pricing_range                   = 8;
}






message ModelDependencies {
                ProgrammingLanguage                                     prog_language                       = 1;    // Programming Language in which this model has been created
                string                                                  prog_language_version               = 2;
                ModelDependency                                         framework_used                      = 3;
    repeated    ModelDependency                                         other_dependencies                  = 4;            
    repeated    jio.brain.proto.stores.PersistentArticleIdAndMetadata   files_needed_by_model_at_runtime    = 5;
}



/**
 * Encapsulates a specific module that be required at 'runtime' 
 * for the model to function properly. The module should be compatible
 * with the programming language in which the model was created and
 * should be found in one of the repositories of the supplied Package 
 * Managers for that model's programming language.
 * 
 * If a dependency is added to a model which is not found at the time
 * of creation of the model an exception will be thrown. 
 */
message ModelDependency {
    string              module_dependency_name      = 1;    // example SkLearn
    string              module_dependency_version   = 2;    // 
    PackageManager      module_package_manager      = 3;    // (Optional) which package manager to use. This would be language specific. For python default will be pip 
    string              module_repo_name            = 4;    // (Optional) package manager specific. For conda - which channel to use to get this dependency 

    enum PackageManager {
        PY_PIP              = 0;
        PY_CONDA            = 1;
        PY_RIL_NEXUS        = 2;
        
        JAVA_MVN_CENTRAL    = 100;
    }
}



/**
 * Model Version encpasulates the physical model filealong with the 
 * note that describes the changes made from the previous version. 
 *
 * It is expected that the actual model will be stored in the ArticleStore
 * and the id of the stored file will be provided as part of Model's
 * version detail. 
 * 
 * The system will fetch the model file from ArticleStore and transform
 * it in the manner required in order to expose it. 
 */
message ModelVersion {
    uint32                                                  version_number                  = 1;
    google.protobuf.Timestamp                               created_at                      = 2;
    ModelVersionState                                       state                           = 3;
    string                                                  change_note                     = 4;
    jio.brain.proto.stores.PersistentArticleIdAndMetadata   model_version_article_info      = 5;
    SerializationModule                                     serialized_with                 = 6;
}




message SerializationModule {

    enum SerializationFormat {
        PICKLE          = 0;
        CLOUD_PICKLE    = 1;
        JOBLIB          = 2;
        HDF5            = 3;
        ZIP             = 4;
    }

    SerializationFormat         format              = 1;
    string                      version_number      = 2;
}




enum ModelVersionState {
    NEW                         = 0;    // Default State
    STORING_MODEL               = 1;       
    STORED_MODEL                = 2;
    CREATING_DOCKER_IMAGE       = 3;
    CREATED_DOCKER_IMAGE        = 4;
    BENCHMARKING                = 5;
    READY                       = 6;
    LAUNCHING                   = 7;
    RUNNING                     = 8;
    STOPPING                    = 9;
    STOPPED                     = 10;
    ARCHIVED                    = 11;
    DELETED                     = 12;
    TEMPORARY_ERROR             = 13;
    ERROR                       = 14;
}




            // ------------------------------------------------------------------ //
            //                 Http Variant Specific Messages
            // ------------------------------------------------------------------ //





message HttpVariant {
    string                              hv_name                             = 1;    
    HttpMethod                          method		                        = 2;
    string                              url				                    = 3;
    PricingRange                        pricing_range                       = 4;
    map<string, FieldOrConstantValue>   params                              = 5;
    map<string, FieldOrConstantValue>   header                              = 6;
	oneof body {
		string                          body_raw 							= 7;
		URLEncodedFormData              body_url_encoded 		            = 8;
		MultiPartFormData               body_form_data 			            = 9;
		string                          body_json 							= 10;
	}
}
            

message URLEncodedFormData {
	map < string, FieldOrConstantValue > form_elements 		= 	1;
}




message MultiPartFormData {
	repeated FormDataElement form_data_element 	= 	1;
}




message FormDataElement {
	enum FormElementType {
		DEFAULT		=	0;
		TXT 		= 	1;
		FILE 		= 	2;
	}

	string name 			= 	1;
	FormElementType type 	= 	2;
	string value 			= 	3;
	string contentType 		= 	4;
}



            // ------------------------------------------------------------------ //
            //              Messages Common to Http & Model Variants
            // ------------------------------------------------------------------ //





message PricingRange {
    float       min_price       = 1;
    float       max_price       = 2;
    Currency    currency        = 3;

    enum Currency {
        INR = 0;
    }
}





message ModelVersionStateChangeEvent {
    uint32                      model_group_id          = 1;
    string                      model_group_id_ext      = 2;
    uint32                      model_version           = 3;
    google.protobuf.Timestamp   timestamp               = 4;
    ModelVersionState           existing_state          = 5;
    ModelVersionState           new_state               = 6;
    string                      additional_info         = 7;
}

